name: Run Backend API Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  backend-api-tests:
    runs-on: ubuntu-latest

    services:
      # Start MongoDB as a service container
      mongo:
        image: mongo:6
        ports:
          - 27019:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'" 
          --health-interval 10s 
          --health-timeout 5s 
          --health-retries 5

    steps:
      - name: Start RabbitMQ
        uses: namoshek/rabbitmq-github-action@v1
        with:
          version: '4.2.1'
          ports: '5673:5672 15673:15672' # Map ports for AMQP and Management UI
          container-name: 'mqtt'

      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"
      
      - name: Set up Node.js for Newman and JWT_SECRET_KEY generation
        uses: actions/setup-node@v4
        with:
          node-version: 22
      
      - name: Install Newman + HTML extra reporter
        run: npm install -g newman newman-reporter-htmlextra

      - name: Set up k6
        uses: grafana/setup-k6-action@v1
        with:
          k6-version: 1.3.0

      - name: Install oasdiff
        run: |
          curl -fsSL https://raw.githubusercontent.com/oasdiff/oasdiff/main/install.sh | sudo sh
          oasdiff -v
      
      - name: Install Schemathesis
        run: |
          pip install schemathesis requests

      - name: Install Python dependencies of API backend
        working-directory: src/backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Install Python dependencies of the Webhook Delivery Worker
        working-directory: src/webhook_delivery_worker
        run: |
          pip install -r requirements.txt
      
      - name: Start Flask backend in the background
        working-directory: src/backend
        env:
          MONGO_URL: mongodb://localhost:27019/soa_demo
          # Required by k6 test at src/backend/tests/k6/load_test.js
          RATE_LIMIT_BY_X_FORWARDED_FOR: true
          RABBITMQ_URL: RABBITMQ_URL=amqp://guest:guest@localhost:5673
        run: |
          # export FLASK_ENV=testing
          export JWT_SECRET_KEY=$(node -e "console.log(require('crypto').randomBytes(32).toString('hex'));")
          flask --version
          nohup flask run --host=0.0.0.0 --port=5000 > flask.log 2>&1 &
      
      - name: Start Webhook Delivery Worker in the background
        working-directory: src/webhook_delivery_worker
        env:
          MONGO_URL: mongodb://localhost:27019/soa_demo
          RABBITMQ_URL: RABBITMQ_URL=amqp://guest:guest@localhost:5673
        run: |
          nohup python -m app > webhook_delivery_worker.log 2>&1 &
      
      - name: Check backend is reachable
        run: |
          for i in {1..20}; do
            if curl -s http://localhost:5000/ > /dev/null; then
              echo "OK - Flask started"
              break
            fi
            sleep 1
          done

          curl -f http://localhost:5000/ || (cat src/backend/flask.log && exit 1)
      
      - name: Test webhooks
        working-directory: src/backend
        env:
          BACKEND_URL: http://localhost:5000/api/v4
        run: |
          python ./tests/webhooks/test.py

      - name: Run all Postman collections with HTML reports
        working-directory: src/backend
        run: |
          ./tests/postman/run_all.sh
      
      - name: Upload HTML reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: newman-html-reports
          path: src/backend/tests/postman/newman-reports/

      - name: Performance Testing with k6
        uses: grafana/run-k6-action@v1
        with:
          path: |
            ./src/backend/tests/k6/*.js
      
      - name: Backward Compatibility Testing with oasdiff (between API v3 and v2)
        run: |
          OLD_SPEC="http://localhost:5000/api/v2/swagger.json"
          NEW_SPEC="http://localhost:5000/api/v3/swagger.json"

          oasdiff changelog --fail-on ERR "$OLD_SPEC" "$NEW_SPEC"

      - name: Backward Compatibility Testing with oasdiff (between API v4 and v3)
        run: |
          OLD_SPEC="http://localhost:5000/api/v3/swagger.json"
          NEW_SPEC="http://localhost:5000/api/v4/swagger.json"

          oasdiff changelog --fail-on ERR "$OLD_SPEC" "$NEW_SPEC"

      - name: Backend API Contract Testing with Schemathesis (v3)
        run: |
          NEW_SPEC="http://localhost:5000/api/v3/swagger.json"

          schemathesis run "$NEW_SPEC" --checks=content_type_conformance --max-examples=3 --phases=examples

      - name: Backend API Contract Testing with Schemathesis (v4)
        run: |
          NEW_SPEC="http://localhost:5000/api/v3/swagger.json"

          schemathesis run "$NEW_SPEC" --checks=content_type_conformance --max-examples=3 --phases=examples
